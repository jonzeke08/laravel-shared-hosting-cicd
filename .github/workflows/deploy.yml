name: Deploy to Hostinger (SSH)

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          command_timeout: "30m"
          script: |
            set -euo pipefail

            REMOTE_PATH="${REMOTE_PATH:-${{ secrets.REMOTE_PATH }}}"
            BRANCH="${BRANCH:-${{ secrets.BRANCH }}}"
            PHP_BIN="${PHP_BIN:-${{ secrets.PHP_BIN }}}"
            COMPOSER_BIN="${COMPOSER_BIN:-${{ secrets.COMPOSER_BIN }}}"

            PHP_BIN=${PHP_BIN:-php}
            COMPOSER_BIN=${COMPOSER_BIN:-composer}
            BRANCH=${BRANCH:-main}

            echo "Deploying to: $REMOTE_PATH on branch: $BRANCH"
            cd "$REMOTE_PATH"
            git fetch --all --prune
            git reset --hard "origin/$BRANCH"

            # Clear any stale cached provider/config files (may reference dev-only packages)
            echo "Clearing Laravel cached bootstrap files..."
            rm -f bootstrap/cache/*.php || true

            echo "Reinstalling Composer deps (prod, no scripts)..."
            rm -rf vendor
            if command -v "$COMPOSER_BIN" >/dev/null 2>&1; then
              "$COMPOSER_BIN" install --no-dev --prefer-dist --no-interaction --no-progress --optimize-autoloader --no-scripts
            elif [ -f composer.phar ]; then
              "$PHP_BIN" composer.phar install --no-dev --prefer-dist --no-interaction --no-progress --optimize-autoloader --no-scripts
            else
              echo "Composer not found. Set COMPOSER_BIN or place composer.phar in project root."
              exit 1
            fi

            echo "Setting writable permissions..."
            chmod -R ug+rw storage bootstrap/cache || true

            echo "Rebuilding discovery and caches..."
            "$PHP_BIN" artisan package:discover --ansi || true
            "$PHP_BIN" artisan config:cache
            "$PHP_BIN" artisan view:cache
            "$PHP_BIN" artisan event:cache || true
            "$PHP_BIN" artisan route:cache || true
            "$PHP_BIN" artisan optimize

            echo "Done."